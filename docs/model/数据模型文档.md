# 数据模型文档

## 用户部分

备注：User表与Passenger表为has many关联

### User 用户

| 编号 | 列名              | 数据类型  | 解释       | 备注                          | 字段标签         |
| ---- | ----------------- | --------- | ---------- | ----------------------------- | ---------------- |
| 2    | UserName          | string    | 用户名     | 字母数字或者下划线"-"，6-30位 | not null;check:; |
| 3    | Password          | string    | 密码       | 不少于6位                     | not null;check:; |
| 4    | PassengerID       | Passenger | 乘客       |                               |                  |
| 5    | RegularPassengers | Passenger | 常用乘车人 |                               |                  |
| 6    | Orders            | Order     | 订单       |                               |                  |

### Passenger 乘客

| 编号 | 字段                | 数据类型 | 解释               | 备注                       | 字段标签 |
| ---- | ------------------- | -------- | ------------------ | -------------------------- | -------- |
| 1    | Name                | string   | 姓名               | 真实姓名                   |          |
| 2    | CertificateType     | uint     | 证件类型           |                            |          |
| 3    | Sex                 | bool     | 性别               | 男和女                     |          |
| 4    | Birthday            | data     | 出生日期           |                            |          |
| 5    | Country             | uint     | 国家               | +86                        |          |
| 6    | CertificateDeadline | data     | 证件有效期截至日期 |                            |          |
| 7    | Certificate         | string   | 证件号码           |                            |          |
| 8    | PassengerType       | uint     | 旅客类型           |                            |          |
| 9    | MobilePhone         | string   | 手机号码           | 默认+86                    |          |
| 10   | Email               | string   | 电子邮箱           |                            |          |
| 11   | CheckStatus         | uint     | 审核状态           | 审核中、审核通过和审核失败 |          |
| 12   | UserStatus          | uint     | 用户状态           | 可用、禁用                 |          |

## 列车部分

### Train 列车

| 编号 | 字段      | 数据类型 | 解释     | 备注 | 字段标签 |
| ---- | --------- | -------- | -------- | ---- | -------- |
| 1    | TrainNo   | string   | 列车代号 |      |          |
| 2    | TrainType | uint     | 列车类型 |      |          |
| 3    | Seats     | Seat     | 座位     |      |          |

### Seat 座位

| 编号 | 字段       | 数据类型 | 解释     | 备注 | 字段标签 |
| ---- | ---------- | -------- | -------- | ---- | -------- |
| 1    | SeatNo     | string   | 座位编号 |      |          |
| 2    | CarNumber  | uint     | 车厢编号 |      |          |
| 3    | Price      | Train    | 列车     |      |          |
| 4    | price      | float    | 票价     |      |          |
| 5    | SeatType   | uint     | 座位类型 |      |          |
| 6    | SeatStatus | uint     | 座位状态 |      |          |

### Schedule 班次

| 编号 | 字段          | 数据类型 | 解释     | 备注 | 字段标签 |
| ---- | ------------- | -------- | -------- | ---- | -------- |
| 1    | train         | Train    | 列车     |      |          |
| 2    | start_station | Station  | 终点站   |      |          |
| 3    | end_station   | Sation   | 起点站   |      |          |
| 4    | start_time    | time     | 出发时间 |      |          |
| 5    | end_time      | time     | 到达时间 |      |          |
| 6    | stop          | Stop     | 经停站   |      |          |
| 7    | duration      | uint     | 沿途时间 |      |          |

### Station 车站

| 编号 | 字段         | 数据类型 | 解释     | 备注 | 字段标签 |
| ---- | ------------ | -------- | -------- | ---- | -------- |
| 1    | station_name | string   | 车站名   |      |          |
| 2    | city         | string   | 城市名   |      |          |
| 3    | city_pinyin  | string   | 拼音     |      |          |
| 4    | first_pinyin | string   | 首字母   |      |          |
| 5    | city_code    | string   | 城市代码 |      |          |
| 6    | station_code | string   | 车站代码 |      |          |

### Stop 经停站

| 编号 | 字段          | 数据类型  | 解释     | 备注 | 字段标签 |
| ---- | ------------- | --------- | -------- | ---- | -------- |
| 1    | schedule      | Schedule  | 班次     |      |          |
| 2    | serial_number | uint      | 站序     |      |          |
| 3    | start_station | Station   | 起始站   |      |          |
| 4    | end_station   | Station   | 终止站   |      |          |
| 5    | start_time    | time.Time | 发车时间 |      |          |
| 6    | end_time      | time.Time | 到达时间 |      |          |
| 7    | duration      | uint      | 沿途时间 |      |          |

## 订单部分

### Order 订单

| 编号 | 字段      | 数据类型  | 解释     | 备注 | 字段标签 |
| ---- | --------- | --------- | -------- | ---- | -------- |
| 1    | trade_no  | string    | 交易编号 |      |          |
| 2    | passenger | Passenger | 乘客     |      |          |
| 3    | user      | User      | 用户     |      |          |
| 4    | schedule  | Schedule  | 班次     |      |          |
| 5    | status    | uint      | 订单状态 |      |          |
| 6    | seat      | Seat      | 座位     |      |          |


## 公共部分

| 编号 | 字段       | 数据类型  | 解释     | 备注 | 字段标签 |
| ---- | ---------- | --------- | -------- | ---- | -------- |
| 1    | id         | uint      | ID       |      |          |
| 2    | created_at | time.Time | 创建时间 |      |          |
| 3    | updated_at | time.Time | 更新时间 |      |          |
| 4    | deleted_at | time.Time | 删除时间 |      |          |



## MySQL优化

### schema与数据类型优化

选择优化的数据类型

- 越小越好
- 简单就好
  - 不应使用字符串存储日期
  - 使用整形存储IP
- 尽量避免使用NULL

### 创建高性能索引

索引类型

- B-Tree 索引
- 哈希索引
- 空间数据索引
- 全文索引

CAP理论认为数据一致性（C）、系统可用性（A）和网络分区容忍性（P），在系统中的任何时刻三个性质中只能同时保证两个性质成立；而网络常常又是不可靠的。



序列化与反序列化

事务四个特性

mysql实现事务的原理



Eric Brewer 提出了 CAP 猜想，之后由Seth Gilbert和Nancy Lynch进行证明y。CAP理论指出，在一个分布式系统中，无法同时满足Consistency、Availability和Partition tolerance。

- Consisitency：all nodes see the same data at the same time.
- Availability：Reads and writes always succeed.
- Partition tolerance：the system continues to operate despite arbitrary message loss or failure of part of the system.



订单服务（生产者）

- 生成预订单 （出票，发送取消预定单消息） grpc 分布式锁-加锁
  - 检查是否存在待支付订单
  - 出票
  - 确认订单

- 取消预定单（退票）  mq 分布式锁-释放锁

- 支付订单（付款）grpc 分布式锁-释放锁

- 退票（退票，退款） mq

车票服务（订阅者）

- 出票 Mysql事务
- 退票

支付服务（订阅者）

- 付款
- 退款



使用redis 设置带有超时的分布式锁 30分钟

如果

